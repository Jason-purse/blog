---
title: Elasticsearch 映射
date: 2022-05-16 19:54:24
categories:
  - 计算机科学
  - 数据库
  - 搜索引擎数据库
  - Elasticsearch
tags:
  - 数据库
  - 搜索引擎数据库
  - Elasticsearch
  - 索引
permalink: /pages/d1bae4/
abbrlink: 54f0d4ef
---

# Elasticsearch 映射

在 Elasticsearch 中，**Mapping** 用于定义文档（`document`）及其包含的字段（`field`）如何存储和索引的。

每个 `document` 都是 `field` 的集合，每个 `field` 都有自己的数据类型。映射数据时，可以创建一个 `mapping`，其中包含与 `document` 相关的 `field` 列表。映射定义还包括元数据 `field`，例如 `_source` ，它自定义如何处理 `document` 的关联元数据。

## 映射方式

`mapping` 分为动态映射和显式映射。

### 动态映射

Elasticsearch 的一个重要功能，通过动态映射，Elasticsearch 可以自动将字段添加到顶级映射以及内部的 [`object`](https://www.elastic.co/guide/en/elasticsearch/reference/current/object.html) 和 [`nested`](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html) 字段。

示例：创建一个名为 `data` 的索引、其 `mapping` 类型为 `_doc`，并且有一个类型为 `long` 的字段 `count`。

```bash
PUT data/_doc/1
{ "count": 5 }
```

#### 动态字段映射

动态字段映射（[Dynamic field mappings](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-field-mapping.html)）是用于管理动态字段检测的规则。

当 Elasticsearch 在文档中检测到新字段时，默认情况下会动态将该字段添加到类型映射中。

[`dynamic`](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic.html) 参数控制此行为：可以通过将动态参数设置为 `true` 或 `runtime` 来开启动态映射。启用动态字段映射后，Elasticsearch 使用内置规则来确定如何映射每个字段的数据类型。

#### 动态模板

**动态模板（[dynamic templates](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic-templates.html)）**是用于给 `mapping` 动态添加字段的自定义规则。

动态模板可以设置匹配条件，只有匹配的情况下才使用动态模板：

- `match_mapping_type` 对 Elasticsearch 检测到的数据类型进行操作
- `match` 和 `unmatch` 使用模式匹配字段名称
- `path_match` 和 `path_unmatch` 对字段的完整虚线路径进行操作
- 如果动态模板没有定义 `match_mapping_type`、`match` 或 `path_match`，则不会匹配任何字段。您仍然可以在批量请求的 `dynamic_templates` 部分按名称引用模板。

【示例】当设置 `'dynamic':'true'` 时，Elasticsearch 会将字符串字段映射为带有关键字子字段的文本字段。如果只是索引结构化内容并且对全文搜索不感兴趣，可以让 Elasticsearch 仅将字段映射为关键字字段。这种情况下，只有完全匹配才能搜索到这些字段。

```javascript
PUT my-index-000001
{
  "mappings": {
    "dynamic_templates": [
      {
        "strings_as_keywords": {
          "match_mapping_type": "string",
          "mapping": {
            "type": "keyword"
          }
        }
      }
    ]
  }
}
```

### 显示映射

**显式映射（[Explicit mapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/explicit-mapping.html)）**：使用显式映射，可以更精细化的控制字段定义。例如：

- 哪些字符串字段应被视为全文字段。
- 哪些字段包含数字、日期或地理位置。
- 日期值的格式。
- 用于控制动态添加字段的自定义规则。

【示例】创建索引时，显示指定 mapping

```javascript
PUT /my-index-000001
{
  "mappings": {
    "properties": {
      "age":    { "type": "integer" },
      "email":  { "type": "keyword"  },
      "name":   { "type": "text"  }
    }
  }
}
```

【示例】在已存在的索引中，指定一个 field 的属性

```javascript
PUT /my-index-000001/_mapping
{
  "properties": {
    "employee-id": {
      "type": "keyword",
      "index": false
    }
  }
}
```

【示例】查看 mapping

```
GET /my-index-000001/_mapping
```

【示例】查看指定 field 的 mapping

```
GET /my-index-000001/_mapping/field/employee-id
```

## 运行时字段

运行时字段是在查询时评估的字段。运行时字段有以下作用：

- 在不重新索引数据的情况下，向现有文档添加字段
- 在不了解数据结构的情况下，也可以处理数据
- 在查询时覆盖从索引字段返回的值
- 为特定用途定义字段而不修改底层架构

检索 Elasticsearch 时，运行时字段和其他字段并没有什么不同。

需要注意的是：使用 `_search` API 上的 `fields` 参数来检索运行时字段的值。运行时字段不会显示在 `_source` 中，但 `fields` API 适用于所有字段，即使是那些未作为原始 `_source` 的一部分发送的字段。

运行时字段在处理日志数据时很有用，尤其是当日志是不确定的数据结构时：这种情况下，会降低搜索速度，但您的索引大小要小得多，您可以更快地处理日志，而无需为它们设置索引。

### 运行时字段的优点

因为**运行时字段没有被索引**，所以添加运行时字段不会增加索引大小。用户可以直接在 mapping 中定义运行时字段，从而节省存储成本并提高采集数据的速度。定义了运行时字段后，可以立即在搜索请求、聚合、过滤和排序中使用它。

如果将运行时字段设为索引字段，则无需修改任何引用运行时字段的查询。更好的是，您可以引用字段是运行时字段的一些索引，以及字段是索引字段的其他索引。您可以灵活地选择要索引哪些字段以及保留哪些字段作为运行时字段。

就其核心而言，运行时字段最重要的好处是能够在您提取字段后将字段添加到文档中。此功能简化了映射决策，因为您不必预先决定如何解析数据，并且可以使用运行时字段随时修改映射。使用运行时字段允许更小的索引和更快的摄取时间，这结合使用更少的资源并降低您的运营成本。

## 字段数据类型

在 Elasticsearch 中，每个字段都有一个字段数据类型或字段类型，用于指示字段包含的数据类型（例如字符串或布尔值）及其预期用途。字段类型按系列分组。同一族中的类型具有完全相同的搜索行为，但可能具有不同的空间使用或性能特征。

Elasticsearch 提供了非常丰富的数据类型，官方将其分为以下几类：

- **普通类型**
  - [`binary`](https://www.elastic.co/guide/en/elasticsearch/reference/current/binary.html)：编码为 Base64 字符串的二进制值。
  - [`boolean`](https://www.elastic.co/guide/en/elasticsearch/reference/current/boolean.html)：布尔类型，值为 true 或 false。
  - [Keywords](https://www.elastic.co/guide/en/elasticsearch/reference/current/keyword.html)：keyword 族类型，包括 `keyword`、`constant_keyword` 和 `wildcard`。
  - [Numbers](https://www.elastic.co/guide/en/elasticsearch/reference/current/number.html)：数字类型，如 `long` 和 `double`
  - **Dates**：日期类型，包括 [`date`](https://www.elastic.co/guide/en/elasticsearch/reference/current/date.html) 和 [`date_nanos`](https://www.elastic.co/guide/en/elasticsearch/reference/current/date_nanos.html)。
  - [`alias`](https://www.elastic.co/guide/en/elasticsearch/reference/current/field-alias.html)：用于定义存在字段的别名。
- **对象类型**
  - [`object`](https://www.elastic.co/guide/en/elasticsearch/reference/current/object.html)：JSON 对象
  - [`flattened`](https://www.elastic.co/guide/en/elasticsearch/reference/current/flattened.html)：整个 JSON 对象作为单个字段值。
  - [`nested`](https://www.elastic.co/guide/en/elasticsearch/reference/current/nested.html)：保留其子字段之间关系的 JSON 对象。
  - [`join`](https://www.elastic.co/guide/en/elasticsearch/reference/current/parent-join.html)：为同一索引中的文档定义父/子关系。
- **结构化数据类型**

  - [Range](https://www.elastic.co/guide/en/elasticsearch/reference/current/range.html)：范围类型，例如：`long_range`、`double_range`、`date_range` 和 `ip_range`。
  - [`ip`](https://www.elastic.co/guide/en/elasticsearch/reference/current/ip.html)：IPv4 和 IPv6 地址。
  - [`version`](https://www.elastic.co/guide/en/elasticsearch/reference/current/version.html)：版本号。支持 [Semantic Versioning](https://semver.org/) 优先规则。
  - [`murmur3`](https://www.elastic.co/guide/en/elasticsearch/plugins/8.2/mapper-murmur3.html)：计算并存储 hash 值。

- **聚合数据类型**

  - [`aggregate_metric_double`](https://www.elastic.co/guide/en/elasticsearch/reference/current/aggregate-metric-double.html)：预先聚合的指标值
  - [`histogram`](https://www.elastic.co/guide/en/elasticsearch/reference/current/histogram.html)：直方图式的预聚合数值。

- **文本搜索类型**
  - [`text` fields](https://www.elastic.co/guide/en/elasticsearch/reference/current/text.html)：text 族类型，包括 `text` 和 `match_only_text`。
  - [`annotated-text`](https://www.elastic.co/guide/en/elasticsearch/plugins/8.2/mapper-annotated-text.html)：包含特殊标记的文本。用于识别命名实体。
  - [`completion`](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters.html#completion-suggester)：用于自动补全。
  - [`search_as_you_type`](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-as-you-type.html)：键入时完成的类似文本的类型。
  - [`token_count`](https://www.elastic.co/guide/en/elasticsearch/reference/current/token-count.html)：文本中标记的计数。
- **文档排名类型**
  - [`dense_vector`](https://www.elastic.co/guide/en/elasticsearch/reference/current/dense-vector.html)：记录浮点数的密集向量。
  - [`rank_feature`](https://www.elastic.co/guide/en/elasticsearch/reference/current/rank-feature.html)：记录一个数字特征，为了在查询时提高命中率。
  - [`rank_features`](https://www.elastic.co/guide/en/elasticsearch/reference/current/rank-features.html)：记录多个数字特征，为了在查询时提高命中率。
- **空间数据类型**

  - [`geo_point`](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-point.html)：地理经纬度
  - [`geo_shape`](https://www.elastic.co/guide/en/elasticsearch/reference/current/geo-shape.html)：复杂的形状，例如多边形
  - [`point`](https://www.elastic.co/guide/en/elasticsearch/reference/current/point.html)：任意笛卡尔点
  - [`shape`](https://www.elastic.co/guide/en/elasticsearch/reference/current/shape.html)：任意笛卡尔几何形状

- **其他类型**
  - [`percolator`](https://www.elastic.co/guide/en/elasticsearch/reference/current/percolator.html)：使用 [Query DSL](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl.html) 编写的索引查询

## 元数据字段

一个文档中，不仅仅包含数据 ，也包含**元数据**。元数据是用于描述文档的信息。

- **标识元数据字段**
  - [`_index`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-index-field.html)：文档所属的索引。
  - [`_id`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-id-field.html)：文档的 ID。
- **文档 source 元数据字段**
  - [`_source`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-source-field.html)：文档正文的原始 JSON。
  - [`_size`](https://www.elastic.co/guide/en/elasticsearch/plugins/8.2/mapper-size.html)：`_source` 字段的大小（以字节为单位），由 [`mapper-size`](https://www.elastic.co/guide/en/elasticsearch/plugins/8.2/mapper-size.html) 插件提供。
- **文档计数元数据字段**
  - [`_doc_count`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-doc-count-field.html)：当文档表示预聚合数据时，用于存储文档计数的自定义字段。
- **索引元数据字段**
  - [`_field_names`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-field-names-field.html)：文档中的所有非空字段。
  - [`_ignored`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-ignored-field.html)：文档中所有的由于 [`ignore_malformed`](https://www.elastic.co/guide/en/elasticsearch/reference/current/ignore-malformed.html) 而在索引时被忽略的字段。
- **路由元数据字段**
  - [`_routing`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-routing-field.html)：将文档路由到特定分片的自定义路由值。
- **其他元数据字段**
  - [`_meta`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-meta-field.html)：应用程序特定的元数据。
  - [`_tier`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-tier-field.html)：文档所属索引的当前数据层首选项。

## 映射参数

Elasticsearch 提供了以下映射参数：

- [`analyzer`](https://www.elastic.co/guide/en/elasticsearch/reference/current/analyzer.html)：指定在索引或搜索文本字段时用于文本分析的分析器。
- [`coerce`](https://www.elastic.co/guide/en/elasticsearch/reference/current/coerce.html)：如果开启，Elasticsearch 将尝试清理脏数据以适应字段的数据类型。
- [`copy_to`](https://www.elastic.co/guide/en/elasticsearch/reference/current/copy-to.html)：允许将多个字段的值复制到一个组字段中，然后可以将其作为单个字段进行查询。
- [`doc_values`](https://www.elastic.co/guide/en/elasticsearch/reference/current/doc-values.html)：默认情况下，所有字段都是被
- [`dynamic`](https://www.elastic.co/guide/en/elasticsearch/reference/current/dynamic.html)：是否开启动态映射。
- [`eager_global_ordinals`](https://www.elastic.co/guide/en/elasticsearch/reference/current/eager-global-ordinals.html)
- [`enabled`](https://www.elastic.co/guide/en/elasticsearch/reference/current/enabled.html)：只能应用于顶级 mapping 定义和 `object` 字段。设置为 `false` 后，Elasticsearch 解析时，会完全跳过该字段。
- [`fielddata`](https://www.elastic.co/guide/en/elasticsearch/reference/current/fielddata.html)：默认情况下， `text` 字段是可搜索的，但不可用于聚合、排序或脚本。如果为字段设置 `fielddata=true`，就会通过反转倒排索引将 fielddata 加载到内存中。请注意，这可能会占用大量内存。如果想对 `text` 字段进行聚合、排序或脚本操作，fielddata 是唯一方法。
- [`fields`](https://www.elastic.co/guide/en/elasticsearch/reference/current/multi-fields.html)：有时候，同一个字段需要以不同目的进行索引，此时可以通过 `fields` 进行配置。
- [`format`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-date-format.html)：用于格式化日期类型。
- [`ignore_above`](https://www.elastic.co/guide/en/elasticsearch/reference/current/ignore-above.html)：字符串长度大于 `ignore_above` 所设，则不会被索引或存储。
- [`ignore_malformed`](https://www.elastic.co/guide/en/elasticsearch/reference/current/ignore-malformed.html)：有时候，同一个字段，可能会存储不同的数据类型。默认情况下，Elasticsearch 解析字段数据类型失败时，会引发异常，并拒绝整个文档。 如果设置 `ignore_malformed` 为 `true`，则允许忽略异常。这种情况下，格式错误的字段不会被索引，但文档中的其他字段可以正常处理。
- [`index_options`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-options.html) 用于控制将哪些信息添加到倒排索引以进行搜索和突出显示。只有 `text` 和 `keyword` 等基于术语（term）的字段类型支持此配置。
- [`index_phrases`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-phrases.html)：如果启用，两个词的组合（shingles）将被索引到一个单独的字段中。这允许以更大的索引为代价，更有效地运行精确的短语查询（无 slop）。请注意，当停用词未被删除时，此方法效果最佳，因为包含停用词的短语将不使用辅助字段，并将回退到标准短语查询。接受真或假（默认）。
- [`index_prefixes`](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-prefixes.html)：index_prefixes 参数启用 term 前缀索引以加快前缀搜索。
- [`index`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-index.html)
- [`meta`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-field-meta.html)
- [`normalizer`](https://www.elastic.co/guide/en/elasticsearch/reference/current/normalizer.html)
- [`norms`](https://www.elastic.co/guide/en/elasticsearch/reference/current/norms.html)
- [`null_value`](https://www.elastic.co/guide/en/elasticsearch/reference/current/null-value.html)
- [`position_increment_gap`](https://www.elastic.co/guide/en/elasticsearch/reference/current/position-increment-gap.html)
- [`properties`](https://www.elastic.co/guide/en/elasticsearch/reference/current/properties.html)
- [`search_analyzer`](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-analyzer.html)
- [`similarity`](https://www.elastic.co/guide/en/elasticsearch/reference/current/similarity.html)
- [`store`](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-store.html)
- [`term_vector`](https://www.elastic.co/guide/en/elasticsearch/reference/current/term-vector.html)

## 映射配置

- `index.mapping.total_fields.limit`：索引中的最大字段数。字段和对象映射以及字段别名计入此限制。默认值为 `1000`。
- `index.mapping.depth.limit`：字段的最大深度，以内部对象的数量来衡量。例如，如果所有字段都在根对象级别定义，则深度为 `1`。如果有一个对象映射，则深度为 `2`，以此类推。默认值为 `20`。
- `index.mapping.nested_fields.limit`：索引中不同 `nested` 映射的最大数量。 `nested` 类型只应在特殊情况下使用，即需要相互独立地查询对象数组。为了防止设计不佳的映射，此设置限制了每个索引的唯一 `nested` 类型的数量。默认值为 `50`。
- `index.mapping.nested_objects.limit`：单个文档中，所有 `nested` 类型中包含的最大嵌套 JSON 对象数。当文档包含太多 `nested` 对象时，此限制有助于防止出现内存溢出。默认值为 `10000`。
- `index.mapping.field_name_length.limit`：设置字段名称的最大长度。默认为 Long.MAX_VALUE（无限制）。

## 参考资料

- [Elasticsearch 官方文档之 Mapping](https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping.html)
