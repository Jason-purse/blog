---
title: 《分布式协议与算法实战》笔记
date: 2022-06-27 11:49:01
categories:
  - 笔记
  - 分布式
  - 分布式理论
tags:
  - 分布式
  - 理论
permalink: /pages/53d3f7/
---

# 《分布式协议与算法实战》笔记

## 拜占庭将军问题

> 拜占庭将军问题是由[莱斯利·兰波特](https://zh.wikipedia.org/wiki/莱斯利·兰波特)在其同名论文中提出的[分布式对等网络](https://zh.wikipedia.org/wiki/对等网络)通信容错问题。其实是借拜占庭将军的例子，抛出了分布式共识性问题，并探讨和论证了解决的方法。
>
> 在[分布式计算](https://zh.wikipedia.org/wiki/分布式計算)中，不同的节点通过通讯交换信息达成共识而按照同一套协作策略行动。但有时候，系统中的节点可能出错而发送错误的信息，用于传递信息的通讯网络也可能导致信息损坏，使得网络中不同的成员关于全体协作的策略得出不同结论，从而破坏系统一致性。拜占庭将军问题被认为是容错性问题中最难的问题类型之一。

### 问题描述

一群拜占庭将军各领一支军队共同围困一座城市。

为了简化问题，军队的行动策略只有两种：**进攻**（Attack，后面简称 A）或 **撤退**（Retreat，后面简称 R）。如果这些军队不是统一进攻或撤退，就可能因兵力不足导致失败。因此，**将军们通过投票来达成一致策略：同进或同退**。

因为将军们分别在城市的不同方位，所以他们只能**通过信使互相联系**。在投票过程中，**每位将军都将自己的投票信息（A 或 R）通知其他所有将军**，这样一来每位将军根据自己的投票和其他所有将军送来的信息就可以分析出共同的投票结果而决定行动策略。

这个抽象模型的问题在于：**将军中可能存在叛徒，他们不仅会发出误导性投票，还可能选择性地发送投票信息**。

由于将军之间需要通过信使通讯，叛变将军可能通过伪造信件来以其他将军的身份发送假投票。而即使在保证所有将军忠诚的情况下，也不能排除信使被敌人截杀，甚至被敌人间谍替换等情况。因此很难通过保证人员可靠性及通讯可靠性来解决问题。

假使那些忠诚（或是没有出错）的将军仍然能通过多数决定来决定他们的战略，便称达到了拜占庭容错。在此，票都会有一个默认值，若消息（票）没有被收到，则使用此默认值来投票。

上述的故事可以映射到分布式系统中，_将军代表分布式系统中的节点；信使代表通信系统；叛徒代表故障或异常_。

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704104211.png)

### 问题分析

> 兰伯特针对拜占庭将军问题，给出了两个解决方案：口头协议和书面协议。
>
> 本文介绍一下口头协议。

在口头协议中，拜占庭将军问题被简化为**将军 - 副官**模型，其核心规则如下：

- 忠诚的副官遵守同一命令。
- 若将军是忠诚的，所有忠诚的副官都执行他的命令。
- **如果叛徒人数为 m，将军人数不能少于 3m + 1** ，那么拜占庭将军问题就能解决了。——关于这个公式，可以不必深究，如果对推导过程感兴趣，可以参考论文。

**示例一、叛徒人数为 1，将军人数为 3**

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704112012.png)

这个示例中，将军人数不满足 3m + 1，无法保证忠诚的副官都执行将军的命令。

**示例二、叛徒人数为 1，将军人数为 4**

![img](https://raw.githubusercontent.com/dunwu/images/dev/snap/20210704194815.png)

这个示例中，将军人数满足 3m + 1，无论是副官中有叛徒，还是将军是叛徒，都能保证忠诚的副官执行将军的命令。

## CAP 理论

CAP 是指：在一个分布式系统中， 一致性、可用性和分区容忍性，最多只能同时满足其中两项。

- **一致性（C：Consistency）**：多个数据副本是否能保持一致
- **可用性（A：Availability）**：分布式系统在面对各种异常时可以提供正常服务的能力
- **分区容忍性（P：Partition Tolerance）**：分布式系统在遇到任何网络分区故障的时候，仍然需要能对外提供一致性和可用性的服务，除非是整个网络环境都发生了故障

<img src="https://raw.githubusercontent.com/dunwu/images/dev/snap/20211102191636.png" style="width: 400px" />

CAP 权衡

在分布式系统中，分区容忍性必不可少，因为需要总是假设网络是不可靠的；CAP 理论实际在是要在可用性和一致性之间做权衡。

- **CP**：需要让所有节点下线成为不可用的状态，等待同步完成。
- **AP**：在同步过程中允许读取所有节点的数据，但是数据可能不一致。

## ACID 理论

ACID 特性：

- **原子性（Atomicity）**
  - 事务被视为不可分割的最小单元，事务中的所有操作要么全部提交成功，要么全部失败回滚。
  - 回滚可以用日志来实现，日志记录着事务所执行的修改操作，在回滚时反向执行这些修改操作即可。
- **一致性（Consistency）**
  - 数据库在事务执行前后都保持一致性状态。
  - 在一致性状态下，所有事务对一个数据的读取结果都是相同的。
- **隔离性（Isolation）**
  - 一个事务所做的修改在最终提交以前，对其它事务是不可见的。
- **持久性（Durability）**
  - 一旦事务提交，则其所做的修改将会永远保存到数据库中。即使系统发生崩溃，事务执行的结果也不能丢失。
  - 可以通过数据库备份和恢复来实现，在系统发生奔溃时，使用备份的数据库进行数据恢复。

![img](https://raw.githubusercontent.com/dunwu/images/dev/cs/database/RDB/数据库ACID.png)

在分布式系统中实现 ACID 比单机复杂的多。

在分布式系统中实现 ACID，即实现分布式事务，具体的方案有如下几种：

- 两阶段提交（2PC）
- 三阶段提交（3PC）
- 补偿事务（TCC）
- 本地消息表（异步确保）
- MQ 事务消息
- Sagas 事务模型

## BASE 理论

BASE 理论是对 CAP 中一致性和可用性权衡的结果。

BASE 是指：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。

BASE 特性

- **基本可用（Basically Available）**：指分布式系统在出现故障的时候，保证核心可用，允许损失部分可用性。
- **软状态（Soft State）**：指允许系统中的数据存在中间状态，并认为该中间状态不会影响系统整体可用性，即允许系统不同节点的数据副本之间进行同步的过程存在延时。
- **最终一致性（Eventually Consistent）**：最终一致性强调的是系统中所有的数据副本，在经过一段时间的同步后，最终能达到一致的状态。

![img](https://raw.githubusercontent.com/dunwu/images/dev/cs/design/architecture/%E5%88%86%E5%B8%83%E5%BC%8F%E7%90%86%E8%AE%BA-BASE.png)

## Paxos 算法

Paxos 算法包含 2 个部分：

一个是 Basic Paxos 算法，描述的是多节点之间如何就某个值（提案 Value）达成共识；

另一个是 Multi-Paxos 思想，描述的是执行多个 Basic Paxos 实例，就一系列值达成共识。

Paxos 三种角色

- 提议者（Proposer）：提议一个值，用于投票表决。在绝大多数场景中，集群中收到客户端请求的节点，才
  是提议者。这样做的好处是，对业务代码没有入侵性，也就是说，我们不需要在业务代码中实现算法逻辑，就可以像使用数据库一样访问后端的数据。
- 接受者（Acceptor）：对每个提议的值进行投票，并存储接受的值。一般来说，集群中的所有节点都在扮演接受者的角色，参与共识协商，并接受和存储数据。
- 学习者（Learner）：被告知投票的结果，接受达成共识的值，存储保存，不参与投票的过程。一般来说，学习者是数据备份节点，比如“Master-Slave”模型中的 Slave，被动地接受数据，容灾备份。

这三种角色，在本质上代表的是三种功能：

- 提议者代表的是接入和协调功能，收到客户端请求后，发起二阶段提交，进行共识协商；
- 接受者代表投票协商和存储数据，对提议的值进行投票，并接受达成共识的值，存储保存；
- 学习者代表存储数据，不参与共识协商，只接受达成共识的值，存储保存。

## Raft 算法

## 一致性哈希算法

## Gossip 协议

## QuorumNWR 算法

## PBFT 算法

## PoW 算法

## ZAB 协议

## InfluxDB 企业版一致性实现剖析

## Hashicorp Raft

## 基于 Raft 的分布式 KV 系统开发实战

## 参考资料

- [分布式协议与算法实战](https://time.geekbang.org/column/intro/100046101)
